⚓ T335612 CVE-2023-36674: Manualthumb bypasses badFile lookupPage MenuHomePhabricatorSearchConfigure Global SearchLog InCreate Task Maniphest  T335612 CVE-2023-36674: Manualthumb bypasses badFile lookupClosed, ResolvedPublicSecurityActionsEdit TaskEdit Related Tasks...Create SubtaskEdit Parent TasksEdit SubtasksMerge Duplicates InClose As DuplicateEdit Related Objects...Edit CommitsEdit MocksEdit RevisionsSubscribeMute NotificationsProtect as security issueAward TokenFlag For LaterAssigned ToArlolraAuthored ByArlolraApr 28 2023, 11:16 PM2023-04-28 23:16:36 (UTC+0)TagsSecurity-Team (Watching)SecurityContent-Transform-Team-WIP (To Verify)MediaWiki-File-management (Backlog)Vuln-Misconfiguration (Tracked)Maintenance-WorktypeCommons (Incoming)Referenced FilesF37123459: 0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_35v2.patchJun 29 2023, 10:00 PM2023-06-29 22:00:07 (UTC+0)F37123452: 0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_38.patchJun 29 2023, 9:52 PM2023-06-29 21:52:27 (UTC+0)F37123435: 0001-SECURITY-Move-badFile-lookup-to-Linker.patchJun 29 2023, 9:22 PM2023-06-29 21:22:31 (UTC+0)F37123316: 0001-SECURITY-Move-badFile-lookup-to-Linker.patchJun 29 2023, 6:41 PM2023-06-29 18:41:35 (UTC+0)F37123301: 0001-SECURITY-Move-badFile-lookup-to-Linker.patchJun 29 2023, 6:08 PM2023-06-29 18:08:51 (UTC+0)F37122589: 0005-SECURITY-Move-badFile-lookup-to-Linker.patchJun 29 2023, 1:01 AM2023-06-29 01:01:56 (UTC+0)F37122588: 0004-A-manualthumb-that-doesn-t-exist-should-be-considere.patchJun 29 2023, 1:01 AM2023-06-29 01:01:56 (UTC+0)F37122590: 0003-Handle-thumb-errors-when-enableLegacyMediaDOM.patchJun 29 2023, 1:01 AM2023-06-29 01:01:56 (UTC+0)View All 15 FilesSubscribersAklapperArlolracscottgerritbotLegoktmMSantosMstylesView All 10 SubscribersDescriptionIf "Bad.jpg" is listed on MediaWiki:Bad image list, you can still do [[File:Good.jpg|thumb=Bad.jpg|Uh oh]]
Here's a patch to fix it,
0001-Move-badFile-lookup-to-Linker.patch6 KBDownload
Unfortunately, it's sitting behind this chain I'm working on https://gerrit.wikimedia.org/r/q/topic:T334659
BranchPatch
REL1_35See T335612#8978250
REL1_38Omitted T335612#8977627
REL1_390005-SECURITY-Move-badFile-lookup-to-Linker.patch7 KBDownload
REL1_400001-SECURITY-Move-badFile-lookup-to-Linker.patch8 KBDownload
master0001-SECURITY-Move-badFile-lookup-to-Linker.patch7 KBDownload
DetailsRisk Rating Low Author Affiliation WMF Product ProjectBranchLines +/-Subjectmediawiki/coreREL1_40+60 -26SECURITY: Move badFile lookup to Linker mediawiki/coremaster+60 -26SECURITY: Move badFile lookup to Linkermediawiki/coreREL1_39+58 -26SECURITY: Move badFile lookup to Linkermediawiki/coreREL1_38+27 -20SECURITY: Move badFile lookup to Linkermediawiki/coreREL1_35+30 -22SECURITY: Move badFile lookup to LinkerCustomize query in gerritRelated ObjectsSearch...Task GraphMentionsStatusSubtypeAssignedTask ResolvedReedyT330174 Formally EOL MW 1.38 ResolvedReedyT329075 Release MW 1.40.0 ResolvedReedyT333616 Release MediaWiki 1.35.11/1.38.7/1.39.4/1.40.0 ResolvedReedyT333617 Tracking bug for MediaWiki 1.35.11/1.38.7/1.39.4/1.40.0 OpenNoneT336146 [EPIC] FY 23-24 unplanned and maintenance for Content Transform Team ResolvedSecurityArlolraT335612 CVE-2023-36674: Manualthumb bypasses badFile lookupMentioned In T333618: Obtain CVEs for 1.35.11/1.38.7/1.39.4 security releasesT329214: Address badfile fixmes Mentioned Here T340390: media parser test failures in REL1_39rMWe0035bbf5a14: Fix frame and frameless rdfa depending on file existingrMWc5c7d5c9bb6d: Fallback to parser-extlink-target instead of setting link-targetrMW6f3b22c41007: Handle thumb errors when !$enableLegacyMediaDOMT333616: Release MediaWiki 1.35.11/1.38.7/1.39.4/1.40.0T333617: Tracking bug for MediaWiki 1.35.11/1.38.7/1.39.4/1.40.0T329214: Address badfile fixmes Event TimelineThere are a very large number of changes, so older changes are hidden. Show Older ChangesRestricted Application added a subscriber: Aklapper.  ·  View Herald TranscriptApr 28 2023, 11:16 PM2023-04-28 23:16:38 (UTC+0)Arlolra added subscribers: ssastry, cscott, Legoktm.Apr 28 2023, 11:17 PM2023-04-28 23:17:07 (UTC+0)Arlolra added a project: Content-Transform-Team-WIP.Apr 28 2023, 11:27 PM2023-04-28 23:27:41 (UTC+0)Reedy added a project: MediaWiki-File-management.Apr 29 2023, 2:24 PM2023-04-29 14:24:21 (UTC+0)Legoktm updated the task description. (Show Details)Apr 30 2023, 10:05 PM2023-04-30 22:05:14 (UTC+0)mmartorana changed the task status from Open to In Progress.May 5 2023, 3:33 PM2023-05-05 15:33:14 (UTC+0)mmartorana triaged this task as Low priority.mmartorana added a project: Vuln-Misconfiguration.mmartorana changed Risk Rating from N/A to Low.Arlolra added a comment.May 8 2023, 2:57 PM2023-05-08 14:57:10 (UTC+0)Comment ActionsUnfortunately, it's sitting behind this chain I'm working on https://gerrit.wikimedia.org/r/q/topic:T334659
These are all merged now.
The patch here will resolve T329214 as well.cscott added a comment.May 9 2023, 9:03 AM2023-05-09 09:03:24 (UTC+0)Comment ActionsTested the patch & review C+2.  Looks good, works in my testing for manual thumb and for ordinary image links, the exception mechanism in MediaWiki:bad_image_list works for manual thumb too.sbassett moved this task from Incoming to Security Patch To Deploy on the Security-Team board.Edited · May 9 2023, 9:23 PM2023-05-09 21:23:49 (UTC+0)sbassett added a subscriber: sbassett.Comment ActionsThanks for the CR, @cscott.  And thanks, @Arlolra, for writing the patch.  Looks like it applies to current master and 1.41.0-wmf.8 but not 1.41.0-wmf.7, the latter likely due to the gerrit relation chain issues discussed above.  We can try to deploy this maybe sometime Thursday (5/11/2023), post-train, once everything is on 1.41.0-wmf.8 or possibly during next Monday's (5/15/2023) standard security deployment window, unless this is far more urgent.Arlolra added a comment.May 9 2023, 11:58 PM2023-05-09 23:58:29 (UTC+0)Comment Actionsunless this is far more urgent.
I think it can wait until one of those windowsArlolra moved this task from Backlog to To Deploy on the Content-Transform-Team-WIP board.May 10 2023, 10:04 PM2023-05-10 22:04:52 (UTC+0)sbassett added a comment.May 15 2023, 8:22 PM2023-05-15 20:22:15 (UTC+0)Comment ActionsAdded [SECURITY] to the patch subject and renamed for production deployment:
01-T335612.patch6 KBDownload
Still tests fine on master and wmf.8.  Should be tracked under T333617 and T276237 once deployed.Mstyles added a subscriber: Mstyles.May 15 2023, 11:04 PM2023-05-15 23:04:18 (UTC+0)Comment Actions
In T335612#8852186, @sbassett wrote:
Added [SECURITY] to the patch subject and renamed for production deployment:
01-T335612.patch6 KBDownload
Still tests fine on master and wmf.8.  Should be tracked under T333617 and T276237 once deployed.
This patch has been deployedMstyles added a parent task: T333617: Tracking bug for MediaWiki 1.35.11/1.38.7/1.39.4/1.40.0.May 15 2023, 11:07 PM2023-05-15 23:07:54 (UTC+0)Mstyles moved this task from Security Patch To Deploy to Watching on the Security-Team board.Arlolra added a comment.May 15 2023, 11:32 PM2023-05-15 23:32:52 (UTC+0)Comment ActionsThanks.  I tested it on wikis where wgParserEnableLegacyMediaDOM is both enabled and disabled,
https://en.wikipedia.org/w/index.php?title=User%3AArlolra%2Fsandbox&diff=1154985575&oldid=1154985505
https://it.wikipedia.org/w/index.php?title=Utente%3AArlolra%2Fsandbox&diff=133524558&oldid=133524549
What's the next step towards getting this merged to master.  I'm not sure what that procedure is.Arlolra moved this task from To Deploy to To Verify on the Content-Transform-Team-WIP board.May 15 2023, 11:33 PM2023-05-15 23:33:34 (UTC+0)Arlolra mentioned this in T329214: Address badfile fixmes.sbassett added a comment.May 16 2023, 2:30 PM2023-05-16 14:30:39 (UTC+0)Comment Actions
In T335612#8852689, @Arlolra wrote:
Thanks.  I tested it on wikis where wgParserEnableLegacyMediaDOM is both enabled and disabled,
https://en.wikipedia.org/w/index.php?title=User%3AArlolra%2Fsandbox&diff=1154985575&oldid=1154985505
https://it.wikipedia.org/w/index.php?title=Utente%3AArlolra%2Fsandbox&diff=133524558&oldid=133524549
Great, thanks!
What's the next step towards getting this merged to master.  I'm not sure what that procedure is.
This patch needs to be held for the next MediaWiki security release (T333616), which should happen sometimes towards the end of June 2023.  If we need to rebase a few times in production against new, conflicting patches in gerrit, we can do that.Arlolra moved this task from To Verify to Blocked on the Content-Transform-Team-WIP board.May 16 2023, 4:40 PM2023-05-16 16:40:40 (UTC+0)Arlolra added a subscriber: MSantos.MSantos added a project: Maintenance-Worktype.Jun 19 2023, 11:27 AM2023-06-19 11:27:50 (UTC+0)Reedy mentioned this in T333618: Obtain CVEs for 1.35.11/1.38.7/1.39.4 security releases.Jun 24 2023, 2:20 PM2023-06-24 14:20:25 (UTC+0)Reedy added a subscriber: GerritBot.Jun 24 2023, 2:23 PM2023-06-24 14:23:48 (UTC+0)Reedy added a subscriber: Reedy.Jun 24 2023, 2:39 PM2023-06-24 14:39:15 (UTC+0)Comment ActionsNoting the lack of rMW6f3b22c41007: Handle thumb errors when !$enableLegacyMediaDOM causes conflicts on REL1_40 (and presumably below)
diff --cc includes/linker/Linker.php
index 562822f1a27,56c22574751..00000000000
--- a/includes/linker/Linker.php
+++ b/includes/linker/Linker.php
@@@ -467,9 -472,12 +467,16 @@@ class Linker 
                        $thumb = false;
                }
  
++<<<<<<< HEAD
 +              if ( !$thumb ) {
++=======
+               $isBadFile = $file && $thumb && $parser &&
+                       $parser->getBadFileLookup()->isBadFile( $title->getDBkey(), $parser->getTitle() );
+ 
+               if ( !$thumb || ( !$enableLegacyMediaDOM && $thumb->isError() ) || $isBadFile ) {
++>>>>>>> b66ca24eefa (SECURITY: Move badFile lookup to Linker)
                        $rdfaType = 'mw:Error ' . $rdfaType;
 -                      $currentExists = $file && $file->exists();
 +                      $label = '';
                        if ( $enableLegacyMediaDOM ) {
                                $label = $frameParams['title'];
                        } else {
@@@ -735,16 -768,24 +742,27 @@@
                                . "<div class=\"thumbinner\" style=\"width:{$outerWidth}px;\">";
                }
  
+               $isBadFile = $exists && $thumb && $parser &&
+                       $parser->getBadFileLookup()->isBadFile(
+                               $manualthumb ? $manual_title : $title->getDBkey(),
+                               $parser->getTitle()
+                       );
+ 
                if ( !$exists ) {
 -                      $rdfaType = 'mw:Error ' . $rdfaType;
                        $label = '';
                        if ( !$enableLegacyMediaDOM ) {
                                $label = $frameParams['alt'] ?? '';
                        }
                        $s .= self::makeBrokenImageLinkObj(
 -                              $title, $label, '', '', '', (bool)$time, $handlerParams, false
 +                              $title, $label, '', '', '', (bool)$time, $handlerParams
                        );
                        $zoomIcon = '';
++<<<<<<< HEAD
 +              } elseif ( !$thumb ) {
++=======
+               } elseif ( !$thumb || ( !$enableLegacyMediaDOM && $thumb->isError() ) || $isBadFile ) {
+                       $rdfaType = 'mw:Error ' . $rdfaType;
++>>>>>>> b66ca24eefa (SECURITY: Move badFile lookup to Linker)
                        if ( $enableLegacyMediaDOM ) {
                                $s .= wfMessage( 'thumbnail_error', '' )->escaped();
                        } else {
Not a big deal... Basically just need to drop the  ( !$enableLegacyMediaDOM && $thumb->isError() ) || part.
Amended patch for REL1_40 applies to REL1_39...
It applies to REL1_38 too, but fails on parser tests... Not sure offhand if we can skip changes to that file, or whether CI will fail that.
In REL1_35 tests/parser/mediaParserTests.txt doesn't exist, and there's bigger conflicts in Parser.php and Linker.php...
Will continue poking.Reedy added a comment.Jun 25 2023, 12:20 PM2023-06-25 12:20:55 (UTC+0)Comment ActionsREL1_39/REL1_40 patch: 0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_40.patch6 KBDownloadReedy added a comment.Jun 25 2023, 12:42 PM2023-06-25 12:42:56 (UTC+0)Comment Actions0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_38.patch4 KBDownload
I'm not quite sure of the parser tests... Most of the changes disappeared from lack of context (which is fine)...
But the mw:Error mw:File/Thumb part.... I guess I probably need to run the tests locally and see if they pass/fail :PReedy added a comment.Edited · Jun 25 2023, 12:45 PM2023-06-25 12:45:32 (UTC+0)Comment ActionsFor REL1_35, the separate file isn't there, but https://github.com/wikimedia/mediawiki/blob/REL1_35/tests/parser/parserTests.txt#L15020 would be rough context to add the test (like is left in REL1_38)...
The other diffs...
diff --cc includes/Linker.php
index 39f15ec3104,411d217b0ac..00000000000
--- a/includes/Linker.php
+++ b/includes/Linker.php
@@@ -413,8 -443,20 +413,25 @@@ class Linker 
                        $thumb = false;
                }
  
++<<<<<<< HEAD
 +              if ( !$thumb ) {
 +                      $s = self::makeBrokenImageLinkObj( $title, $frameParams['title'], '', '', '', $time == true );
++=======
+               $isBadFile = $file && $thumb && $parser &&
+                       $parser->getBadFileLookup()->isBadFile( $title->getDBkey(), $parser->getTitle() );
+ 
+               if ( !$thumb || $isBadFile ) {
+                       $rdfaType = 'mw:Error ' . $rdfaType;
+                       $label = '';
+                       if ( $enableLegacyMediaDOM ) {
+                               // This is the information for tooltips for inline images which
+                               // Parsoid stores in data-mw.  See T273014
+                               $label = $frameParams['title'];
+                       }
+                       $s = self::makeBrokenImageLinkObj(
+                               $title, $label, '', '', '', (bool)$time, $handlerParams
+                       );
++>>>>>>> 8e2cd5f5026 (SECURITY: Move badFile lookup to Linker)
                } else {
                        self::processResponsiveImages( $file, $thumb, $handlerParams );
                        $params = [
@@@ -588,17 -695,51 +605,34 @@@
                        && !isset( $frameParams['link-title'] )
                        && !isset( $frameParams['link-url'] )
                        && !isset( $frameParams['no-link'] ) ) {
 -                      $frameParams['link-title'] = $title;
 -                      $frameParams['link-title-query'] = $linkTitleQuery;
 +                      $frameParams['link-url'] = $url;
                }
  
 -              if ( $frameParams['align'] != '' ) {
 -                      // Possible values: mw-halign-left mw-halign-center mw-halign-right mw-halign-none
 -                      $classes[] = "mw-halign-{$frameParams['align']}";
 -              }
 -
 -              if ( isset( $frameParams['class'] ) ) {
 -                      $classes[] = $frameParams['class'];
 -              }
 -
 -              $s = '';
 -
 -              if ( $enableLegacyMediaDOM ) {
 -                      $s .= "<div class=\"thumb t{$frameParams['align']}\">"
 -                              . "<div class=\"thumbinner\" style=\"width:{$outerWidth}px;\">";
 -              }
 +              $s = "<div class=\"thumb t{$frameParams['align']}\">"
 +                      . "<div class=\"thumbinner\" style=\"width:{$outerWidth}px;\">";
  
+               $isBadFile = $exists && $thumb && $parser &&
+                       $parser->getBadFileLookup()->isBadFile(
+                               $manualthumb ? $manual_title : $title->getDBkey(),
+                               $parser->getTitle()
+                       );
+ 
                if ( !$exists ) {
 -                      $label = '';
 -                      if ( $enableLegacyMediaDOM ) {
 -                              // This is the information for tooltips for inline images which
 -                              // Parsoid stores in data-mw.  See T273014
 -                              $label = $frameParams['title'];
 -                      }
 -                      $s .= self::makeBrokenImageLinkObj(
 -                              $title, $label, '', '', '', (bool)$time, $handlerParams
 -                      );
 +                      $s .= self::makeBrokenImageLinkObj( $title, $frameParams['title'], '', '', '', $time == true );
                        $zoomIcon = '';
++<<<<<<< HEAD
 +              } elseif ( !$thumb ) {
 +                      $s .= wfMessage( 'thumbnail_error', '' )->escaped();
++=======
+               } elseif ( !$thumb || $isBadFile ) {
+                       if ( $enableLegacyMediaDOM ) {
+                               $s .= wfMessage( 'thumbnail_error', '' )->escaped();
+                       } else {
+                               $s .= self::makeBrokenImageLinkObj(
+                                       $title, '', '', '', '', (bool)$time, $handlerParams
+                               );
+                       }
++>>>>>>> 8e2cd5f5026 (SECURITY: Move badFile lookup to Linker)
                        $zoomIcon = '';
                } else {
                        if ( !$noscale && !$manualthumb ) {
diff --cc includes/parser/Parser.php
index 1295165d0b9,2b0351399fe..00000000000
--- a/includes/parser/Parser.php
+++ b/includes/parser/Parser.php
@@@ -2615,27 -2660,25 +2615,49 @@@ class Parser 
                                        continue;
                                }
  
++<<<<<<< HEAD
 +                              if ( $ns == NS_FILE ) {
 +                                      if ( !$this->badFileLookup->isBadFile( $nt->getDBkey(), $this->getTitle() ) ) {
 +                                              if ( $wasblank ) {
 +                                                      # if no parameters were passed, $text
 +                                                      # becomes something like "File:Foo.png",
 +                                                      # which we don't want to pass on to the
 +                                                      # image generator
 +                                                      $text = '';
 +                                              } else {
 +                                                      # recursively parse links inside the image caption
 +                                                      # actually, this will parse them in any other parameters, too,
 +                                                      # but it might be hard to fix that, and it doesn't matter ATM
 +                                                      $text = $this->handleExternalLinks( $text );
 +                                                      $holders->merge( $this->handleInternalLinks2( $text ) );
 +                                              }
 +                                              # cloak any absolute URLs inside the image markup, so handleExternalLinks() won't touch them
 +                                              $s .= $prefix . $this->armorLinks(
 +                                                      $this->makeImage( $nt, $text, $holders ) ) . $trail;
 +                                              continue;
 +                                      }
 +                              } elseif ( $ns == NS_CATEGORY ) {
++=======
+                               if ( $ns === NS_FILE ) {
+                                       if ( $wasblank ) {
+                                               # if no parameters were passed, $text
+                                               # becomes something like "File:Foo.png",
+                                               # which we don't want to pass on to the
+                                               # image generator
+                                               $text = '';
+                                       } else {
+                                               # recursively parse links inside the image caption
+                                               # actually, this will parse them in any other parameters, too,
+                                               # but it might be hard to fix that, and it doesn't matter ATM
+                                               $text = $this->handleExternalLinks( $text );
+                                               $holders->merge( $this->handleInternalLinks2( $text ) );
+                                       }
+                                       # cloak any absolute URLs inside the image markup, so handleExternalLinks() won't touch them
+                                       $s .= $prefix . $this->armorLinks(
+                                               $this->makeImage( $nt, $text, $holders ) ) . $trail;
+                                       continue;
+                               } elseif ( $ns === NS_CATEGORY ) {
++>>>>>>> 8e2cd5f5026 (SECURITY: Move badFile lookup to Linker)
                                        /**
                                         * Strip the whitespace Category links produce, see T2087
                                         */
* Unmerged path tests/parser/mediaParserTests.txt
Not sure why Parser.php is complaining, but it's clearly just whitespace related...Reedy added a comment.Jun 25 2023, 12:51 PM2023-06-25 12:51:45 (UTC+0)Comment Actions0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_35.patch4 KBDownloadReedy edited subscribers, added: jenkins-bot; removed: GerritBot.Jun 25 2023, 12:55 PM2023-06-25 12:55:29 (UTC+0)Reedy added a comment.Edited · Jun 25 2023, 1:05 PM2023-06-25 13:05:28 (UTC+0)Comment Actions
In T335612#8962417, @Reedy wrote:
0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_35.patch4 KBDownload
But this won't work, as the $parser parameter into makeThumbLink2 doesn't exist yet... Not a problem for other branches.
Was added in rMWc5c7d5c9bb6d: Fallback to parser-extlink-target instead of setting link-target.Reedy added a comment.Jun 25 2023, 1:27 PM2023-06-25 13:27:12 (UTC+0)Comment ActionsIgnoring the failures in T340390: media parser test failures in REL1_39... In REL1_39
Running test Bad images - basic functionality [legacy]... FAILED!
/var/www/wiki-1.39/core/tests/parser/mediaParserTests.txt:175
--- /tmp/mwParser-expectedigbsbH2023-06-25 14:23:15.204382604 +0100
+++ /tmp/mwParser-actualJbxaDG2023-06-25 14:23:15.204382604 +0100
@@ -1,2 +1,2 @@
-<p><span class="mw-default-size" typeof="mw:Error mw:File"><a href="/wiki/File:Bad.jpg" title="File:Bad.jpg"><span class="mw-file-element mw-broken-media" data-width="320">File:Bad.jpg</span></a></span>
+<p><span class="mw-default-size" typeof="mw:File"><a href="/wiki/File:Bad.jpg" class="mw-file-description"><img alt="Bad.jpg" src="http://example.com/images/0/09/Bad.jpg" decoding="async" width="320" height="240" /></a></span>
 </p>
Running test Bad images - T18039: text after bad image disappears [legacy]... FAILED!
/var/www/wiki-1.39/core/tests/parser/mediaParserTests.txt:188
--- /tmp/mwParser-expectedV7V4XX2023-06-25 14:23:15.220382816 +0100
+++ /tmp/mwParser-actualbn6Wtd2023-06-25 14:23:15.220382816 +0100
@@ -1,4 +1,4 @@
 <p>Foo bar
-<span class="mw-default-size" typeof="mw:Error mw:File"><a href="/wiki/File:Bad.jpg" title="File:Bad.jpg"><span class="mw-file-element mw-broken-media" data-width="320">File:Bad.jpg</span></a></span>
+<span class="mw-default-size" typeof="mw:File"><a href="/wiki/File:Bad.jpg" class="mw-file-description"><img alt="Bad.jpg" src="http://example.com/images/0/09/Bad.jpg" decoding="async" width="320" height="240" /></a></span>
 Bar foo
 </p>
Running test Bad images - manualthumb [legacy]... FAILED!
/var/www/wiki-1.39/core/tests/parser/mediaParserTests.txt:207
--- /tmp/mwParser-expectedwR8dCd2023-06-25 14:23:15.236383029 +0100
+++ /tmp/mwParser-actualyNW7Dy2023-06-25 14:23:15.236383029 +0100
@@ -1 +1 @@
-<figure typeof="mw:Error mw:File/Thumb"><a href="/wiki/File:Foobar.jpg" title="File:Foobar.jpg"><span class="mw-file-element mw-broken-media" data-width="180">Error creating thumbnail: </span></a><figcaption>Uh oh</figcaption></figure>
+<figure typeof="mw:File/Thumb"><a href="/wiki/File:Foobar.jpg" title="File:Foobar.jpg"><img alt="" src="http://example.com/images/0/09/Bad.jpg" decoding="async" width="320" height="240" /></a><figcaption>Uh oh</figcaption></figure>
Running test Bad images - in gallery [legacy]... FAILED!
/var/www/wiki-1.39/core/tests/parser/mediaParserTests.txt:217
--- /tmp/mwParser-expectedEsFPT92023-06-25 14:23:15.252383241 +0100
+++ /tmp/mwParser-actualIJs0k72023-06-25 14:23:15.252383241 +0100
@@ -1,6 +1,6 @@
 <ul class="gallery mw-gallery-traditional">
 <li class="gallerybox" style="width: 155px">
-<div class="thumb" style="height: 150px;"><span typeof="mw:Error mw:File"><a href="/index.php?title=Special:Upload&amp;wpDestFile=Bad.jpg" class="new" title="File:Bad.jpg"><span class="mw-broken-media" data-width="120" data-height="120">File:Bad.jpg</span></a></span></div>
+<div class="thumb" style="width: 150px; height: 150px;"><span typeof="mw:File"><a href="/wiki/File:Bad.jpg" class="mw-file-description"><img alt="Bad.jpg" src="http://example.com/images/thumb/0/09/Bad.jpg/120px-Bad.jpg" decoding="async" width="120" height="90" srcset="http://example.com/images/thumb/0/09/Bad.jpg/180px-Bad.jpg 1.5x, http://example.com/images/thumb/0/09/Bad.jpg/240px-Bad.jpg 2x" /></a></span></div>
 <div class="gallerytext">
 </div>
 </li>
Which I suspect is due to the other related changes, such as rMWe0035bbf5a14: Fix frame and frameless rdfa depending on file existing which is adding extra $rdfaType = 'mw:Error ' . $rdfaType; into the mixReedy added a comment.Jun 25 2023, 1:52 PM2023-06-25 13:52:13 (UTC+0)Comment ActionsAnd https://gerrit.wikimedia.org/r/q/topic:T334659-2 won't apply onto REL1_40... First patch is trivial conflicts, second gets more complex, etc. Similar for REL1_39 too?
I'm a little stuck what to do here....
We can skip parser test changes, which may or may not leave (other) failures behind.
For REL1_35, we could "just" use \MediaWiki\MediaWikiServices::getInstance()->getParser() to gain an instance to play with..Reedy renamed this task from Manualthumb bypasses badFile lookup to CVE-2023-36674: Manualthumb bypasses badFile lookup.Jun 26 2023, 10:57 AM2023-06-26 10:57:54 (UTC+0)Arlolra added a comment.Jun 29 2023, 1:01 AM2023-06-29 01:01:56 (UTC+0)Comment ActionsHere are the backports for REL1_39.  Let me know if that works for you and I'll continue with the rest.
0001-Fix-frame-and-frameless-rdfa-depending-on-file-exist.patch4 KBDownload
0002-Pass-whether-current-rev-of-file-exists-to-Linker-ma.patch6 KBDownload
0003-Handle-thumb-errors-when-enableLegacyMediaDOM.patch4 KBDownload
0004-A-manualthumb-that-doesn-t-exist-should-be-considere.patch2 KBDownload
0005-SECURITY-Move-badFile-lookup-to-Linker.patch7 KBDownloadReedy added a comment.Jun 29 2023, 8:30 AM2023-06-29 08:30:52 (UTC+0)Comment ActionsThanks!
If they're not security patches, they can be done in public to make everything easier :)
I'll stick those first 4 in gerrit in a bit and get them merged too.
I would suggest it's probably not worth doing that full stack (if possible) for REL1_38 as that is basically EOL as of this week. We could just say it's not fixed there.
REL1_35 is EOL in about 3 months too.Reedy added a comment.Jun 29 2023, 10:42 AM2023-06-29 10:42:50 (UTC+0)Comment Actions
In T335612#8975039, @Arlolra wrote:
Here are the backports for REL1_39.  Let me know if that works for you and I'll continue with the rest.
0001-Fix-frame-and-frameless-rdfa-depending-on-file-exist.patch4 KBDownload
0002-Pass-whether-current-rev-of-file-exists-to-Linker-ma.patch6 KBDownload
0003-Handle-thumb-errors-when-enableLegacyMediaDOM.patch4 KBDownload
0004-A-manualthumb-that-doesn-t-exist-should-be-considere.patch2 KBDownload
These are now merged into REL1_39 with minor changes (removing a use, adding $ back to a variable), ontop of some mediawiki-phan-config 0.12.0/0.12.1 backports (for ease, plus LTS).
Should mean the security patch is a trivial pick ontop.
I started trying to put the same stack of patches onto REL1_40, but parsertest failure on the first one, so stopped - https://gerrit.wikimedia.org/r/c/mediawiki/core/+/934012Arlolra added a comment.Jun 29 2023, 6:08 PM2023-06-29 18:08:51 (UTC+0)Comment ActionsI started trying to put the same stack of patches onto REL1_40, but parsertest failure on the first one, so stopped - https://gerrit.wikimedia.org/r/c/mediawiki/core/+/934012
Here you go,
https://gerrit.wikimedia.org/r/q/topic:T334659-2-REL1_40
0001-SECURITY-Move-badFile-lookup-to-Linker.patch8 KBDownloadArlolra added a comment.Jun 29 2023, 6:10 PM2023-06-29 18:10:02 (UTC+0)Comment ActionsI would suggest it's probably not worth doing that full stack (if possible) for REL1_38 as that is basically EOL as of this week. We could just say it's not fixed there.
That's fineReedy added a comment.Jun 29 2023, 6:15 PM2023-06-29 18:15:18 (UTC+0)Comment ActionsGreat, thanks!
I guess this is a low enough severity security fix, for quite a narrow case... This seems fine for me for REL1_35 and REL1_38 to suggest that people upgrade.
I'll have to get the CVE updated laterArlolra added a comment.Jun 29 2023, 6:19 PM2023-06-29 18:19:33 (UTC+0)Comment ActionsREL1_35 is EOL in about 3 months too.
Probably reasonable to just backport a variant of the security patch.  I'll see what I can do
For REL1_35, we could "just" use \MediaWiki\MediaWikiServices::getInstance()->getParser() to gain an instance to play with..
We just need the badfile service, not the whole parser, I think
That makes me wonder though, the patch I've supplied only considers parser contexts (the check is moved from the parser to the linker) but maybe there are other places where user controlled content make images that should check if it's a bad file?Arlolra added a comment.Jun 29 2023, 6:41 PM2023-06-29 18:41:35 (UTC+0)Comment ActionsOh, I should note, the security patches I uploaded in T335612#8975039 and T335612#8977622 are amended ever so slightly from the original one, to add a test case to the legacy media parsertests file and alter the error output.  Here's the same thing that applies to master and is the patch I'd prefer to land there.
0001-SECURITY-Move-badFile-lookup-to-Linker.patch7 KBDownload
Here's the diff between the two,
commit b4d38b335a6d994d3d1645c8a695620299c08a8d
Author: Arlo Breault <abreault@wikimedia.org>
Date:   Fri Apr 28 19:00:50 2023 -0400
    Diff
    
    Change-Id: I42a61870e8ff8d49d6566531a410557382a94800
diff --git a/includes/linker/Linker.php b/includes/linker/Linker.php
index 56c22574751..c53a412d9c1 100644
--- a/includes/linker/Linker.php
+++ b/includes/linker/Linker.php
@@ -787,7 +787,13 @@ class Linker {
 } elseif ( !$thumb || ( !$enableLegacyMediaDOM && $thumb->isError() ) || $isBadFile ) {
 $rdfaType = 'mw:Error ' . $rdfaType;
 if ( $enableLegacyMediaDOM ) {
-$s .= wfMessage( 'thumbnail_error', '' )->escaped();
+if ( !$thumb ) {
+$s .= wfMessage( 'thumbnail_error', '' )->escaped();
+} else {
+$s .= self::makeBrokenImageLinkObj(
+$title, '', '', '', '', (bool)$time, $handlerParams, true
+);
+}
 } else {
 if ( $thumb && $thumb->isError() ) {
 Assert::invariant(
@@ -795,8 +801,10 @@ class Linker {
 'Unknown MediaTransformOutput: ' . get_class( $thumb )
 );
 $label = $thumb->toText();
-} else {
+} elseif ( !$thumb ) {
 $label = wfMessage( 'thumbnail_error', '' )->text();
+} else {
+$label = '';
 }
 $s .= self::makeBrokenImageLinkObj(
 $title, $label, '', '', '', (bool)$time, $handlerParams, true
diff --git a/tests/parser/legacyMedia.txt b/tests/parser/legacyMedia.txt
index 3cad1ab784d..863ff3c77c1 100644
--- a/tests/parser/legacyMedia.txt
+++ b/tests/parser/legacyMedia.txt
@@ -218,6 +218,16 @@ Bar foo
 Bar foo</p>
 !! end
 
+!! test
+Bad images - manualthumb
+!! config
+wgParserEnableLegacyMediaDOM=true
+!! wikitext
+[[File:Foobar.jpg|thumb=Bad.jpg|Uh oh]]
+!! html/php
+<div class="thumb tright"><div class="thumbinner" style="width:322px;"><a href="/wiki/File:Foobar.jpg" title="File:Foobar.jpg">File:Foobar.jpg</a>  <div class="thumbcaption">Uh oh</div></div></div>
+!! end
+
 !! test
 Bad images - in gallery
 !! config
diff --git a/tests/parser/media.txt b/tests/parser/media.txt
index 902deac44a8..beb01e33b62 100644
--- a/tests/parser/media.txt
+++ b/tests/parser/media.txt
@@ -235,7 +235,7 @@ wgParserEnableLegacyMediaDOM=false
 !! wikitext
 [[File:Foobar.jpg|thumb=Bad.jpg|Uh oh]]
 !! html/php
-<figure typeof="mw:Error mw:File/Thumb"><a href="/wiki/File:Foobar.jpg" title="File:Foobar.jpg"><span class="mw-file-element mw-broken-media" data-width="180">Error creating thumbnail: </span></a><figcaption>Uh oh</figcaption></figure>
+<figure typeof="mw:Error mw:File/Thumb"><a href="/wiki/File:Foobar.jpg" title="File:Foobar.jpg"><span class="mw-file-element mw-broken-media" data-width="180">File:Foobar.jpg</span></a><figcaption>Uh oh</figcaption></figure>
 !! end
 
 !! testReedy updated the task description. (Show Details)Jun 29 2023, 6:52 PM2023-06-29 18:52:58 (UTC+0)Arlolra updated the task description. (Show Details)Jun 29 2023, 7:22 PM2023-06-29 19:22:37 (UTC+0)Arlolra added a comment.Jun 29 2023, 9:22 PM2023-06-29 21:22:31 (UTC+0)Comment Actions
In T335612#8977661, @Arlolra wrote:
For REL1_35, we could "just" use \MediaWiki\MediaWikiServices::getInstance()->getParser() to gain an instance to play with..
We just need the badfile service, not the whole parser, I think
Ah, but then there's no article title context.  Here's a backport to REL1_35, if you want it.  Unfortunately, the tests were still disabled at the time of this release but I tried it out locally.
0001-SECURITY-Move-badFile-lookup-to-Linker.patch4 KBDownloadArlolra updated the task description. (Show Details)Jun 29 2023, 9:23 PM2023-06-29 21:23:12 (UTC+0)Reedy added a comment.Jun 29 2023, 9:52 PM2023-06-29 21:52:27 (UTC+0)Comment Actions
In T335612#8978250, @Arlolra wrote:
In T335612#8977661, @Arlolra wrote:
For REL1_35, we could "just" use \MediaWiki\MediaWikiServices::getInstance()->getParser() to gain an instance to play with..
We just need the badfile service, not the whole parser, I think
Ah, but then there's no article title context.  Here's a backport to REL1_35, if you want it.  Unfortunately, the tests were still disabled at the time of this release but I tried it out locally.
0001-SECURITY-Move-badFile-lookup-to-Linker.patch4 KBDownload
Thanks
I suspect phan or something will complain about the && $parser on https://phabricator.wikimedia.org/F37123435$31 because it's not nullable, so it should always be true-y.
Easily fixed, so will try and run phan locally and see... And then amend if necessary.
I've just forward ported that to REL1_38, unclear if it's going to break any parser tests...
0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_38.patch3 KBDownload (untested)
TBH, it might be worth getting CI to run and merge the patches in the open before I actually build the releasesReedy added a comment.Jun 29 2023, 9:59 PM2023-06-29 21:59:13 (UTC+0)Comment Actions
In T335612#8978454, @Reedy wrote:
I suspect phan or something will complain about the && $parser on https://phabricator.wikimedia.org/F37123435$31 because it's not nullable, so it should always be true-y.
Easily fixed, so will try and run phan locally and see... And then amend if necessary.
includes/Linker.php:416 PhanRedundantCondition Redundant attempt to cast $parser of type \Parser to truthy
Heh, yup.
Passes if I remove that :)Reedy added a comment.Jun 29 2023, 10:00 PM2023-06-29 22:00:07 (UTC+0)Comment Actions0001-SECURITY-Move-badFile-lookup-to-Linker-REL1_35v2.patch4 KBDownloadArlolra added a comment.Jun 29 2023, 10:32 PM2023-06-29 22:32:59 (UTC+0)Comment ActionsI've just forward ported that to REL1_38, unclear if it's going to break any parser tests...
The bad image tests are disabled in REL1_38, so probably not
I suspect phan or something will complain about the && $parser on https://phabricator.wikimedia.org/F37123435$31 because it's not nullable, so it should always be true-y.
Ugh 😔 That's in all the patchesReedy added a comment.Jun 29 2023, 10:38 PM2023-06-29 22:38:24 (UTC+0)Comment ActionsIf REL1_38 is probably ok, might aswell include the patch then. Gives us a clean sweep.
The && $parser is easily fixed anyway :) - I'll sort it when I'm staging them tomorrowArlolra added a comment.Jun 29 2023, 10:48 PM2023-06-29 22:48:53 (UTC+0)Comment ActionsOk, thank you, and sorry for the messReedy added a comment.Jun 29 2023, 10:53 PM2023-06-29 22:53:10 (UTC+0)Comment ActionsDon't worry. You've more than helped sorting the backports :)Reedy edited subscribers, added: gerritbot; removed: jenkins-bot.Jun 30 2023, 3:32 PM2023-06-30 15:32:59 (UTC+0)Arlolra moved this task from Blocked to To Verify on the Content-Transform-Team-WIP board.Jun 30 2023, 3:37 PM2023-06-30 15:37:22 (UTC+0)gerritbot added a comment.Jun 30 2023, 3:48 PM2023-06-30 15:48:41 (UTC+0)Comment ActionsChange 934563 merged by jenkins-bot:
[mediawiki/core@REL1_35] SECURITY: Move badFile lookup to Linker
https://gerrit.wikimedia.org/r/934563gerritbot added a comment.Jun 30 2023, 3:49 PM2023-06-30 15:49:44 (UTC+0)Comment ActionsChange 934566 merged by jenkins-bot:
[mediawiki/core@REL1_38] SECURITY: Move badFile lookup to Linker
https://gerrit.wikimedia.org/r/934566gerritbot added a comment.Jun 30 2023, 4:02 PM2023-06-30 16:02:42 (UTC+0)Comment ActionsChange 934568 merged by jenkins-bot:
[mediawiki/core@REL1_39] SECURITY: Move badFile lookup to Linker
https://gerrit.wikimedia.org/r/934568gerritbot added a comment.Jun 30 2023, 4:11 PM2023-06-30 16:11:44 (UTC+0)Comment ActionsChange 934571 merged by jenkins-bot:
[mediawiki/core@master] SECURITY: Move badFile lookup to Linker
https://gerrit.wikimedia.org/r/934571Reedy closed this task as Resolved.Jun 30 2023, 4:21 PM2023-06-30 16:21:28 (UTC+0)Reedy assigned this task to Arlolra.gerritbot added a comment.Jun 30 2023, 4:31 PM2023-06-30 16:31:50 (UTC+0)Comment ActionsChange 934584 had a related patch set uploaded (by Reedy; author: Arlolra):
[mediawiki/core@REL1_40] SECURITY: Move badFile lookup to Linker
https://gerrit.wikimedia.org/r/934584gerritbot added a project: Patch-For-Review.Jun 30 2023, 4:31 PM2023-06-30 16:31:53 (UTC+0)gerritbot added a comment.Jun 30 2023, 4:50 PM2023-06-30 16:50:40 (UTC+0)Comment ActionsChange 934584 merged by jenkins-bot:
[mediawiki/core@REL1_40] SECURITY: Move badFile lookup to Linker
https://gerrit.wikimedia.org/r/934584Reedy removed a project: Patch-For-Review.Jun 30 2023, 5:42 PM2023-06-30 17:42:24 (UTC+0)Reedy changed the visibility from "Custom Policy" to "Public (No Login Required)".Reedy changed the edit policy from "Custom Policy" to "All Users".Maintenance_bot added a project: Commons.Jun 30 2023, 5:46 PM2023-06-30 17:46:23 (UTC+0)MSantos added a parent task: T336146: [EPIC] FY 23-24 unplanned and maintenance for Content Transform Team.Jul 20 2023, 10:01 AM2023-07-20 10:01:18 (UTC+0)Content licensed under Creative Commons Attribution-ShareAlike 4.0 (CC-BY-SA) unless otherwise noted; code licensed under GNU General Public License (GPL) or other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · Wikimedia Foundation · Privacy Policy · Code of Conduct · Terms of Use · Disclaimer · CC-BY-SA · GPL