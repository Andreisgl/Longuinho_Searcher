Extension:CentralNotice - MediaWiki
Jump to content
Main menu
Main menu
move to sidebar
hide
Navigation
Main pageGet MediaWikiGet extensionsTech blogContribute
Support
User helpFAQTechnical manualSupport deskCommunication
Development
Developer portalCode statistics
MediaWiki.org
Community portalRecent changesTranslate contentRandom pageVillage pumpSandbox
In other languages
Add links
Search
Search
 EnglishCreate accountLog in
Personal tools
 Create account Log in
Pages for logged out editors learn more
ContributionsTalk
Contents
move to sidebar
hide
Beginning
1Installation
Toggle Installation subsection
1.1For all wikis
1.2The infrastructure wiki
1.3Subscribing wikis
1.4Quick developer setup
1.5Dependencies
2Getting help
3Permissions
4Design concepts
Toggle Design concepts subsection
4.1Design documents
5GeoIP lookup
6Usage
Toggle Usage subsection
6.1New Banner
6.2New Campaign
6.3Overriding selection
7Limitations
8API
9See also
Toggle the table of contents
Toggle the table of contents
Extension:CentralNotice
Issue tracker: #mediawiki-extensions-centralnotice
ExtensionDiscussion
English
ReadView sourceView history
Tools
Tools
move to sidebar
hide
Actions
ReadView sourceView history
General
What links hereRelated changesUpload fileSpecial pagesPermanent linkPage informationCite this pageWikidata item
Print/export
Create a bookDownload as PDFPrintable version
From mediawiki.org
Translate this pageLanguages:Bahasa Indonesia
Deutsch
Deutsch (Sie-Form)
English
Türkçe
español
français
polski
português
čeština
русский
中文
日本語
MediaWiki extensions manual 
 CentralNotice
Release status:  stable
Implementation 
Special page , API 
Description 
Adds a central sitenotice
Author(s) 
Andrew Russell Green, Matthew Walker, Adam Roses Wight
Formerly: Brion Vibber, Tomasz Finc, Trevor Parscal, Ryan Kaldari
Latest version 
2.6.1 (continuous updates)
Compatibility policy 
Snapshots releases along with MediaWiki. Master is not backward compatible.
MediaWiki 
>= 1.41.0
Database changes 
Yes
Tables 
cn_notices cn_assignments cn_templates cn_notice_languages cn_notice_projects cn_notice_countries cn_notice_regions cn_template_mixins cn_notice_mixins cn_notice_mixin_params cn_known_devices cn_template_devices cn_known_mobile_carriers cn_notice_mobile_carriers cn_notice_log cn_template_log 
License 
GNU General Public License 2.0 or later
Download
Download extension Git [?]: 
Download Git master
browse repository (GitHub)
commit history
repository contributors (GitHub)
code review
Example 
 Special:CentralNotice on Meta (read-only)
Parameters 
$wgNoticeBannerMaxAge
$wgNoticeBannerReducedMaxAge
$wgNoticeHideUrls
$wgCentralNoticeCategoriesUsingLegacy
$wgNoticeUseLanguageConversion
$wgNoticeCookieDurations
$wgCentralNoticeBannerMixins
$wgCentralMobileSelectedBannerDispatcher
$wgNoticeInfrastructure
$wgCentralBannerRecorder
$wgNoticeBucketExpiry
$wgNoticeCookieDomain
$wgNoticeTranslateDeployStates
$wgCentralNoticeAdminGroup
$wgCentralNoticeCampaignTypes
$wgCentralNoticeImpressionEventSampleRate
$wgCentralNoticeESITestString
$wgCentralNoticeFallbackHideCookieDuration
$wgCentralSelectedBannerDispatcher
$wgCentralHost
$wgNoticeProject
$wgNoticeTabifyPages
$wgCentralNoticeGeoIPBackgroundLookupModule
$wgCentralNoticeApiUrl
$wgNoticeProjects
$wgCentralNoticeMessageProtectRight
$wgCentralNoticeMaxCampaignFallback
$wgCentralNoticeContentSecurityPolicy
$wgCentralNoticeCampaignMixins
$wgCentralDBname
$wgCentralNoticeSampleRate
$wgCentralNoticePerCampaignBucketExtension
$wgNoticeNumberOfControllerBuckets
$wgNoticeNumberOfBuckets
$wgNoticeUseTranslateExtension
$wgCentralNoticeHideBannersP3P
$wgCentralNoticeLoader
Hooks used 
CanonicalNamespaces ChangeTagsListActive GetPreferences ListDefinedTags LoadExtensionSchemaUpdates PreferencesGetIcon ResourceLoaderRegisterModules SkinTemplateNavigation::Universal UserMergeAccountFields 
Hooks provided 
CentralNoticeCampaignChange 
Quarterly downloads
64 (Ranked 106th)
Public wikis using
1,012 (Ranked 228th)
Translate the CentralNotice extension if it is available at translatewiki.net
Issues 
Open tasks · Report a bug
The CentralNotice extension delivers announcements (usually in the form of banners) to Wikimedia wikis.
It is used heavily by the Fundraising team to solicit donations, and for announcements of interest to Wikimedia communities and users.
CentralNotice can target announcements by country, language, project, device and logged-in status.
This page has information for CentralNotice developers and wiki administrators who want to install CentralNotice on their own sites.
To learn how to create and configure CentralNotice campaigns, please see Help:CentralNotice on Meta-Wiki.
For information about the CentralNotice setup on the Wikimedia Foundation's cluster, see CentralNotice on Wikitech.
CentralNotice allows central distribution of announcements to many wikis (called subscribing wikis) from a central wiki (the infrastructure wiki).
If you only need to post messages to a single wiki, consider using Sitenotice instead.
Installation
CentralNotice is developed, tested, and known to be deployed only on wikis that do not use table prefixing. If your setup uses table prefixing there is no guarantee this extension will work. Please report any bugs to Phabricator.
For all wikis
Download the latest snapshot and extract it to your extensions directory.
Add to LocalSettings.php  the following: wfLoadExtension( 'CentralNotice' );
By default, GeoIP lookup is disabled. If the Geo cookie is pre-populated, however, its value will be used. For local development, you can enable a client-side implementation that uses https://freegeoip.net as follows. For more information, see #GeoIP lookup.
$wgCentralNoticeGeoIPBackgroundLookupModule = 'ext.centralNotice.freegeoipLookup';
The infrastructure wiki
From the command line, go to the wiki root and run php maintenance/update.php
Edit LocalSettings.php and set ...
$wgNoticeInfrastructure to true
$wgNoticeProjects to be an array of projects that will subscribe to the central wiki. For example array( 'wikipedia', 'wiktionary' )
By default the sysop group is the only group with the ability to administer CentralNotice. If additional groups are needed, assign them the centralnotice-admin and edit-interface permissions.
Subscribing wikis
Edit LocalSettings.php and set...
$wgNoticeInfrastructure to false;
$wgNoticeProject to be an entry in $wgNoticeProjects;
$wgCentralHost to the protocol (potentially neutral) and domain of the central wiki. For example //meta.wikimedia.org;
$wgCentralSelectedBannerDispatcher to the URL of Special:BannerLoader on the central wiki, for example: //meta.wikimedia.org/w/index.php/Special:BannerLoader;
either $wgCentralDBname to the name of the infrastructure wiki's database, or $wgCentralNoticeApiUrl to the API endpoint of the infrastructure wiki; and
$wgCentralBannerRecorder to the URL of Special:RecordImpression on the central wiki. For example: //meta.wikimedia.org/w/index.php/Special:RecordImpression.
Quick developer setup
For most development tasks, you can use a single wiki in both infrastructure and subscribing roles.
Following are sample lines to include in LocalSetting.php.
(See notes in comments.)
wfLoadExtension( 'CentralNotice' );
$wgNoticeInfrastructure = true;
$wgNoticeProjects = array( 'centralnoticeproject' ); # 'centralnoticeproject' can be any string
$wgNoticeProject = 'centralnoticeproject'; # must be the same as above
$wgCentralHost = 'localhost';
$wgCentralSelectedBannerDispatcher = 'http://localhost/mw/index.php?title=Special:BannerLoader';
$wgCentralDBname = 'databasename'; # the same as $wgDBname
$wgCentralNoticeGeoIPBackgroundLookupModule = 'ext.centralNotice.freegeoipLookup';
All code that runs on subscribing wikis should be smoke-tested with MobileFrontend , to ensure they work on the mobile version of the site.
Dependencies
Some CentralNotice features require other MediaWiki extensions, including EventLogging  and Translate .
Getting help
The WMF Fundraising tech  team are the maintainers of CentralNotice.
For questions about installation, bug reports, or usage of CentralNotice please send an email to the mailing list wikitech-l@lists.wikimedia.org or join us in the IRC channel #wikimedia-fundraising connect.
Permissions
centralnotice-admin — Permission required to modify campaigns and banners. Relevant only to the infrastructure wikis (see also bugzilla:26377).
edit-interface is required to edit banner content.
Design concepts
From a user facing perspective, the high level CentralNotice objects are campaigns (a.k.a. notices) and banners (a.k.a. templates).
These are affected by the back end concepts of selectors and allocation.
Banner — a single block of translatable html/wikitext/css/javascript that will display at the top of Manual:$wgContentNamespaces  pages. The user status, device type, UI language selectors are applied to banners.
Banners may be grouped by category. All banners in a category share user side cookies, such as the hiding cookie that is set when a user clicks a banner close button.
Campaign — a collection of banners. The project, country and content language selectors apply at the campaign level. The system allows as many active campaigns at the same time as you want dynamically calculating an allocation for each banner in an active campaign. Campaigns are defined as active if the central wiki time is greater than the campaign start time, less than the campaign end time, and the campaign is marked as enabled.
Banners in a campaign are assigned a bucket and weight. Buckets are yet another selector, and weight affects the relative allocation of banners inside a campaign.
There are four priority levels in CentralNotice. Higher priority campaigns will get a greater allocation of page views.
Campaigns may be locked which will prevent editing and deletion of the campaign; but not the banners inside a campaign.
Selector — any property which may be filtered on for the purposes of allocation. This allows, for example, different banners to be shown to logged in versus logged out users in Argentina browsing Wikipedia in English.
A selection vector is the complete set of selectors a user presents to the central wiki when requesting a banner.
Allocation — The chance a banner will be shown to a user under a given selection vector.
Design documents
Design Research Project 2017
Banner allocation algorithm
Database schema / table layout
GeoIP lookup
By default, CentralNotice has no client-side GeoIP lookup service configured.
This is optimised for the Wikimedia Foundation production configuration where Varnish populates the Geo cookie from the server-side.
(See wikitech:Geolocation.)
You can configure CentralNotice to use a custom data source client-side through the CentralNoticeGeoIPBackgroundLookupModule configuration variable.
This variable expects the name of a ResourceLoader module that exports a function.
The function will be called without parameters and should return a Promise that resolves with an object containing the following properties:
country: string - Two-letter country code.
region: string - Implementation specific.
city: string - City name.
lat: number.
lon: number.
Usage
Full usage instructions can be found at meta:Help:CentralNotice.
New Banner
Load Special:CentralNoticeBanners
Click on the add banner link at the bottom of the page (must be logged in as an admin).
Enter in a name and the raw HTML for the given banner.
If this banner is going to be translated then enclose any text to be translated with triple parens - {{{FOO}}}.
Submit
(TODO: move and expand this snippet)
Each banner has its banner definition stored in MediaWiki:Centralnotice-template-<name>
All of its messages are stored below the banner defined in MediaWiki:Centralnotice-template-<name>-<message>/<language_code>
New Campaign
Load Special:CentralNotice
Add a campaign with a given start time at the bottom portion of the page, leave a comment, and click submit.
If this campaign is only run on a specific wiki and or language then select it from the pull downs.
Click on the new campaign and add the banners you want within this running campaign and their respective weights.
If all looks well then set this campaign to enabled and it will show at the corresponding time.
Overriding selection
Add any of the following URL parameters to preview a specific banner, defeat "diet" schemes, or debug pseudorandom banner selection.
banner
You can test a banner directly on any wiki by adding ?banner=<bannername> to the end of the URL.
randomcampaign
A decimal number between 0 and 1, to be used as the "random" seed for choosing a campaign.
randombanner
A decimal number between 0 and 1, to be used as the "random" seed for choosing a banner among banners available in the chosen campaign.
country
Override the country code, before filtering to geotargeted campaigns. Accepts two-character ISO 3166-1 codes.
uselang
Its usual meaning in MediaWiki, this determines which banners you may be shown. Beware of content language vs. user language.
force
Override any banner hiding code, show the banner.
reset
Zero out any cookies being used to customize banner display (e.g. delivered impression count).
For example,
https://en.wikipedia.org/wiki/Special:Random?banner=B18WMDE_authors_02_180801_2&uselang=en&force=1
https://it.wikisource.org/wiki/Speciale:RandomRootpage?randomcampaign=0.142
Limitations
Banners do not display on pages in the Special namespace, as well as edit pages and diff pages.
API
CentralNotice adds two API modules, centralnoticechoicedata and centralnoticequerycampaign.
(The API module centralnoticeallocations was deprecated and removed in MediaWiki 1.25.)
The following documentation is the output of Special:ApiHelp/centralnoticechoicedata, automatically generated by the pre-release version of MediaWiki that is running on this site (MediaWiki.org).
action=centralnoticechoicedata(main | centralnoticechoicedata)
This module requires read rights.Source: CentralNoticeLicense: GPL-2.0-or-later
Get data needed to choose a banner for a given project and language
Parameters:projectThe project to get banner choice data for.
This parameter is required.languageThe language to get banner choice data for.
This parameter is required.
Example:Get the data for choosing a banner for English Wikipedia users.api.php?action=centralnoticechoicedata&project=wikipedia&language=en [open in sandbox]
The following documentation is the output of Special:ApiHelp/centralnoticequerycampaign, automatically generated by the pre-release version of MediaWiki that is running on this site (MediaWiki.org).
action=centralnoticequerycampaign(main | centralnoticequerycampaign)
This module requires read rights.Source: CentralNoticeLicense: GPL-2.0-or-later
Get all configuration settings for a campaign.
Parameter:campaignCampaign name. Separate multiple values with a "|" (vertical bar).
Default: (empty)
Example:Show campaign "Plea_US"api.php?action=centralnoticequerycampaign&format=json&campaign=Plea_US [open in sandbox]
See also
Help:CentralNotice and Changes following refactoring (2015-09) on meta
Extension:CentralNotice/Campaign and banner selection 
Extension:CentralNotice/Impression diet 
Extension:CentralNotice/Special:RecordImpression 
Extension:CentralNotice/Statuses, reasons and status codes 
Extension:CentralNotice/Banner_mixins 
Requests for comment/CentralNotice Caching Overhaul - Frontend Proxy
Extension:CentralNotice/Notes/Miscelaneous doc bits 
Extension:CentralNotice/Notes/Documentation rewrite 
Extension:CentralNotice/Notes/Campaign-associated_mixins_and_banner_history 
Extension:CentralNotice/Notes/Banner controller refactoring 
Other subpages of this page (warning: many are outdated)
This extension is being used on one or more Wikimedia projects. This probably means that the extension is stable and works well enough to be used by such high-traffic websites. Look for this extension's name in Wikimedia's CommonSettings.php and InitialiseSettings.php configuration files to see where it's installed. A full list of the extensions installed on a particular wiki can be seen on the wiki's Special:Version page.
This extension is included in the following wiki farms/hosts and/or packages: 
Miraheze 
WikiForge
WikiTide
This is not an authoritative list. Some wiki farms/hosts and/or packages may contain this extension even if they are not listed here. Always check with your wiki farms/hosts or bundle to confirm.
Retrieved from "https://www.mediawiki.org/w/index.php?title=Extension:CentralNotice&oldid=6019019"
Categories: Stable extensionsSpecial page extensionsAPI extensionsGPL licensed extensionsExtensions in Wikimedia version controlCanonicalNamespaces extensionsChangeTagsListActive extensionsGetPreferences extensionsListDefinedTags extensionsLoadExtensionSchemaUpdates extensionsPreferencesGetIcon extensionsResourceLoaderRegisterModules extensionsSkinTemplateNavigation::Universal extensionsUserMergeAccountFields extensionsAll extensionsExtensions used on WikimediaExtensions included in MirahezeExtensions included in WikiForgeExtensions included in WikiTideExtensions for data exchange with other local wikisExtensions supporting fundraising and donationsFundraisingHidden category: Extensions with release branches compatibility policy
 This page was last edited on 9 July 2023, at 01:20.
Text is available under the Creative Commons Attribution-ShareAlike License;
additional terms may apply.
See Terms of Use for details.
Privacy policy
About MediaWiki.org
Disclaimers
Code of Conduct
Mobile view
Developers
Statistics
Cookie statement
Toggle limited content width